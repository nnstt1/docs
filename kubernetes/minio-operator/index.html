<!doctype html><html lang=ja class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=nnstt1><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.8"><title>MinIO Operator - nnstt1 memo</title><link rel=stylesheet href=../../assets/stylesheets/main.6e60f8b8.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.e6a45f82.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#minio-operator class=md-skip> コンテンツにスキップ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=ヘッダー> <a href=../.. title="nnstt1 memo" class="md-header__button md-logo" aria-label="nnstt1 memo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> nnstt1 memo </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> MinIO Operator </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=検索 placeholder=検索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=クリア tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 検索を初期化 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/nnstt1/docs/ title=リポジトリへ class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> nnstt1/docs </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=タブ data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Author </a> </li> <li class=md-tabs__item> <a href=../../mkdocs/ class=md-tabs__link> HomeLab </a> </li> <li class=md-tabs__item> <a href=../../ansible/ class=md-tabs__link> Ansible </a> </li> <li class=md-tabs__item> <a href=../container-runtime/ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../prometheus/prometheus/ class=md-tabs__link> Prometheus </a> </li> <li class=md-tabs__item> <a href=../../raspi-ceph/initial-setup/ class=md-tabs__link> Raspi Ceph </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=ナビゲーション data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="nnstt1 memo" class="md-nav__button md-logo" aria-label="nnstt1 memo" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> nnstt1 memo </label> <div class=md-nav__source> <a href=https://github.com/nnstt1/docs/ title=リポジトリへ class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> nnstt1/docs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Author </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> HomeLab <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=HomeLab data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> HomeLab </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mkdocs/ class=md-nav__link> MkDocs </a> </li> <li class=md-nav__item> <a href=../../powerdns/ class=md-nav__link> PowerDNS </a> </li> <li class=md-nav__item> <a href=../../esxi/ class=md-nav__link> ESXi </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Ansible <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ansible data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Ansible </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ansible/ class=md-nav__link> Index </a> </li> <li class=md-nav__item> <a href=../../ansible/tower/ class=md-nav__link> Ansible Tower </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../container-runtime/ class=md-nav__link> コンテナランタイム </a> </li> <li class=md-nav__item> <a href=../maintenance/ class=md-nav__link> Maintenance </a> </li> <li class=md-nav__item> <a href=../krew/ class=md-nav__link> Krew </a> </li> <li class=md-nav__item> <a href=../istio/ class=md-nav__link> Istio </a> </li> <li class=md-nav__item> <a href=../metallb/ class=md-nav__link> MetalLB </a> </li> <li class=md-nav__item> <a href=../velero/ class=md-nav__link> Velero </a> </li> <li class=md-nav__item> <a href=../rook/ class=md-nav__link> Rook </a> </li> <li class=md-nav__item> <a href=../zalando-postgres-operator/ class=md-nav__link> Zalando Postgres Operator </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> MinIO Operator <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> MinIO Operator </a> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 前提条件 </a> <nav class=md-nav aria-label=前提条件> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> バージョン </a> </li> <li class=md-nav__item> <a href=#namespace class=md-nav__link> namespace </a> </li> <li class=md-nav__item> <a href=#storageclass class=md-nav__link> StorageClass </a> </li> <li class=md-nav__item> <a href=#krew class=md-nav__link> Krew </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> インストール </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> テナント作成 </a> <nav class=md-nav aria-label=テナント作成> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> トラブル </a> </li> <li class=md-nav__item> <a href=#2021513 class=md-nav__link> 2021/5/13 </a> </li> <li class=md-nav__item> <a href=#2021514 class=md-nav__link> 2021/5/14 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 外部公開用サービス </a> <nav class=md-nav aria-label=外部公開用サービス> <ul class=md-nav__list> <li class=md-nav__item> <a href=#minio class=md-nav__link> MinIO </a> </li> <li class=md-nav__item> <a href=#console class=md-nav__link> Console </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> アンインストール </a> <nav class=md-nav aria-label=アンインストール> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> テナント削除 </a> </li> <li class=md-nav__item> <a href=#operator class=md-nav__link> Operator 削除 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> Prometheus <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Prometheus data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Prometheus </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../prometheus/prometheus/ class=md-nav__link> Prometheus </a> </li> <li class=md-nav__item> <a href=../../prometheus/snmp-exporter/ class=md-nav__link> SNMP Exporter </a> </li> <li class=md-nav__item> <a href=../../prometheus/kube-prometheus/ class=md-nav__link> kube-prometheus </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> Raspi Ceph <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Raspi Ceph" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Raspi Ceph </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../raspi-ceph/initial-setup/ class=md-nav__link> ラズパイ初期設定 </a> </li> <li class=md-nav__item> <a href=../../raspi-ceph/cephadm/ class=md-nav__link> Ceph クラスタ構築 </a> </li> <li class=md-nav__item> <a href=../../raspi-ceph/ceph-grafana/ class=md-nav__link> Ceph-Grafana コンテナ </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目次> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目次 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 前提条件 </a> <nav class=md-nav aria-label=前提条件> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> バージョン </a> </li> <li class=md-nav__item> <a href=#namespace class=md-nav__link> namespace </a> </li> <li class=md-nav__item> <a href=#storageclass class=md-nav__link> StorageClass </a> </li> <li class=md-nav__item> <a href=#krew class=md-nav__link> Krew </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> インストール </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> テナント作成 </a> <nav class=md-nav aria-label=テナント作成> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> トラブル </a> </li> <li class=md-nav__item> <a href=#2021513 class=md-nav__link> 2021/5/13 </a> </li> <li class=md-nav__item> <a href=#2021514 class=md-nav__link> 2021/5/14 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 外部公開用サービス </a> <nav class=md-nav aria-label=外部公開用サービス> <ul class=md-nav__list> <li class=md-nav__item> <a href=#minio class=md-nav__link> MinIO </a> </li> <li class=md-nav__item> <a href=#console class=md-nav__link> Console </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> アンインストール </a> <nav class=md-nav aria-label=アンインストール> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_8 class=md-nav__link> テナント削除 </a> </li> <li class=md-nav__item> <a href=#operator class=md-nav__link> Operator 削除 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/nnstt1/docs/edit/master/docs/kubernetes/minio-operator.md title=編集 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=minio-operator>MinIO Operator</h1> <p>S3 互換のオブジェクトストレージである MinIO を Kubernetes 上で運用するための <a href=https://github.com/minio/operator>Minio Operator</a> について説明します。</p> <h2 id=_1>前提条件</h2> <h3 id=_2>バージョン</h3> <p><strong><code>Kubernetes クラスタのバージョンが 1.17.0 以上であること</code></strong></p> <p>1.17.0 未満だったら Kubernetes 公式を参照してアップグレードします。</p> <div class=highlight><pre><span></span><code>$ kubectl version
Client Version: version.Info<span class=o>{</span>Major:<span class=s2>&quot;1&quot;</span>, Minor:<span class=s2>&quot;21&quot;</span>, GitVersion:<span class=s2>&quot;v1.21.0&quot;</span>, GitCommit:<span class=s2>&quot;cb303e613a121a29364f75cc67d3d580833a7479&quot;</span>, GitTreeState:<span class=s2>&quot;clean&quot;</span>, BuildDate:<span class=s2>&quot;2021-04-08T16:31:21Z&quot;</span>, GoVersion:<span class=s2>&quot;go1.16.1&quot;</span>, Compiler:<span class=s2>&quot;gc&quot;</span>, Platform:<span class=s2>&quot;linux/amd64&quot;</span><span class=o>}</span>
Server Version: version.Info<span class=o>{</span>Major:<span class=s2>&quot;1&quot;</span>, Minor:<span class=s2>&quot;21&quot;</span>, GitVersion:<span class=s2>&quot;v1.21.0&quot;</span>, GitCommit:<span class=s2>&quot;cb303e613a121a29364f75cc67d3d580833a7479&quot;</span>, GitTreeState:<span class=s2>&quot;clean&quot;</span>, BuildDate:<span class=s2>&quot;2021-04-08T16:25:06Z&quot;</span>, GoVersion:<span class=s2>&quot;go1.16.1&quot;</span>, Compiler:<span class=s2>&quot;gc&quot;</span>, Platform:<span class=s2>&quot;linux/amd64&quot;</span><span class=o>}</span>
</code></pre></div> <h3 id=namespace>namespace</h3> <p><strong><code>Kubernetes クラスタに MinIO テナント用の namespace があること</code></strong></p> <p>テナント毎に namespace を作成します。</p> <div class=highlight><pre><span></span><code>$ kubectl create namespace minio-tenant-1
namespace/minio-tenant-1 created
</code></pre></div> <h3 id=storageclass>StorageClass</h3> <p><strong><code>Kubernetes クラスタに volumeBindingMode: WaitForFirstConsumer の StorageClass があること</code></strong></p> <p>MinIO Operator が使用する Storage Class を用意する方法として <code>Local Volume</code> と <code>Rook/Ceph</code> の 2 通り紹介します。</p> <dl> <dt><strong>Local Volume</strong></dt> <dd> <p>Local Volume を使う方法は<a href=https://docs.min.io/minio/k8s/tenant-management/deploy-minio-tenant.html#configure-the-persistent-volumes target=_blank>公式ドキュメント <i class="fa fa-external-link"></i></a>にも記載があります。</p> <p>まず、Kubernetes の 各 Worker ノードのローカルストレージを使用する StorageClass を作成します。</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">local-storage</span><span class=w></span>
<span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/no-provisioner</span><span class=w></span>
<span class=nt>volumeBindingMode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">WaitForFirstConsumer</span><span class=w></span>
</code></pre></div> <p>Local Volume はダイナミックプロビジョニングができないため、個別に PersistentVolume を作成します。</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">PV-NAME</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4Gi</span><span class=w></span>
<span class=w>  </span><span class=nt>volumeMode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Filesystem</span><span class=w></span>
<span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span><span class=w></span>
<span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Retain</span><span class=w></span>
<span class=w>  </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">local-storage</span><span class=w></span>
<span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/mnt/minio</span><span class=w></span>
<span class=w>  </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>required</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w></span>
<span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span><span class=w></span>
<span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">In</span><span class=w></span>
<span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w></span>
<span class=w>              </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">NODE-NAME</span><span class=w></span>
</code></pre></div> <dl> <dt><code>metadata.name</code></dt> <dd>PersistentVolume の名前を定義します。</dd> <dt><code>spec.capacity.storage</code></dt> <dd>PersistentVolume で確保するストレージサイズを指定します。</dd> <dt><code>spec.storage-class</code></dt> <dd>作成した StorageClass の名前を指定します。</dd> <dt><code>spec.nodeAffinity</code></dt> <dd>ローカルストレージを持つノードの名前を指定します。 ここで指定されたノードのストレージが消費されます。</dd> <dt><code>spec.local.path</code></dt> <dd>PersistentVolume をノードにマウントするパスを指定します。</dd> </dl> </dd> <dt><strong>Rook/Ceph</strong></dt> <dd> <p>Rook/Ceph を導入済みの環境であれば、MinIO Operator 用の CephBlockPool と StorageClass を作成して使うことが可能です。</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ceph.rook.io/v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">CephBlockPool</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-pool</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>failureDomain</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">host</span><span class=w></span>
<span class=w>  </span><span class=nt>replicated</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class=w></span>
<span class=w>    </span><span class=nt>requireSafeReplicaSize</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=nn>---</span><span class=w></span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-rook-ceph-block</span><span class=w></span>
<span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph.rbd.csi.ceph.com</span><span class=w></span>
<span class=nt>parameters</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>clusterID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>    </span><span class=nt>pool</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">replicapool</span><span class=w></span>
<span class=w>    </span><span class=nt>imageFormat</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2&quot;</span><span class=w></span>
<span class=w>    </span><span class=nt>imageFeatures</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">layering</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/provisioner-secret-name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-csi-rbd-provisioner</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/provisioner-secret-namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/controller-expand-secret-name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-csi-rbd-provisioner</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/controller-expand-secret-namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/node-stage-secret-name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-csi-rbd-node</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/node-stage-secret-namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rook-ceph</span><span class=w></span>
<span class=w>    </span><span class=nt>csi.storage.k8s.io/fstype</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ext4</span><span class=w></span>
<span class=nt>allowVolumeExpansion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class=w></span>
<span class=nt>reclaimPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Delete</span><span class=w></span>
<span class=nt>volumeBindingMode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">WaitForFirstConsumer</span><span class=w></span>
</code></pre></div> </dd> </dl> <h3 id=krew>Krew</h3> <p><strong><code>Krew がインストールされていること</code></strong></p> <p><a href=../krew/ >こちらのページ</a> を参照して Krew をインストールします。</p> <h2 id=_3>インストール</h2> <p>Krew を使って MinIO Operator をインストールしていきます。</p> <div class=highlight><pre><span></span><code>$ kubectl krew update
Updated the <span class=nb>local</span> copy of plugin index.

$ kubectl krew install minio
Updated the <span class=nb>local</span> copy of plugin index.
Installing plugin: minio
Installed plugin: minio
<span class=se>\</span>
 <span class=p>|</span> Use this plugin:
 <span class=p>|</span>      kubectl minio
 <span class=p>|</span> Documentation:
 <span class=p>|</span>      https://github.com/minio/operator/tree/master/kubectl-minio
 <span class=p>|</span> Caveats:
 <span class=p>|</span> <span class=se>\</span>
 <span class=p>|</span>  <span class=p>|</span> * For resources that are not <span class=k>in</span> default namespace, currently you must
 <span class=p>|</span>  <span class=p>|</span>   specify -n/--namespace explicitly <span class=o>(</span>the current namespace setting is not
 <span class=p>|</span>  <span class=p>|</span>   yet used<span class=o>)</span>.
 <span class=p>|</span> /
/
WARNING: You installed plugin <span class=s2>&quot;minio&quot;</span> from the krew-index plugin repository.
   These plugins are not audited <span class=k>for</span> security by the Krew maintainers.
   Run them at your own risk.
</code></pre></div> <p>インストールできたら、Operator を初期化します。</p> <div class=highlight><pre><span></span><code>$ kubectl minio init
namespace/minio-operator created
serviceaccount/minio-operator created
clusterrole.rbac.authorization.k8s.io/minio-operator-role created
clusterrolebinding.rbac.authorization.k8s.io/minio-operator-binding created
customresourcedefinition.apiextensions.k8s.io/tenants.minio.min.io created
service/operator created
deployment.apps/minio-operator created
serviceaccount/console-sa created
clusterrole.rbac.authorization.k8s.io/console-sa-role created
clusterrolebinding.rbac.authorization.k8s.io/console-sa-binding created
configmap/console-env created
service/console created
deployment.apps/console created
-----------------

To open Operator UI, start a port forward using this command:

kubectl minio proxy -n minio-operator 

-----------------
</code></pre></div> <p>上記出力の通り、proxy 経由で MinIO Operator の管理画面にアクセスできるようになります。</p> <div class=highlight><pre><span></span><code>$ kubectl minio proxy -n minio-operator
Starting port forward of the Console UI.

To connect open a browser and go to http://localhost:9090

Current JWT to login: eyJhbGciOiJSUzI1NiIsImtpZCI6Ii0zbFc4cm51LXNPTWliSUVOYXdTNmI3ejRWeWRuVEF0dU9aenpKY0xaNGMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJtaW5pby1vcGVyYXRvciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJjb25zb2xlLXNhLXRva2VuLWJmNDZyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImNvbnNvbGUtc2EiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI3ZDgwZDNjOS0wMzUyLTRjNDItOWQ5Yy0xM2I3ZDg2ZjA4OWIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6bWluaW8tb3BlcmF0b3I6Y29uc29sZS1zYSJ9.F8XsI2buT71U4QUi7tfShaDYAOs0rcgjPmZO5HiJYyWYZ0ZYN5LDZbIRf4il23CGRjGVUWksKsfeUqRFD0iG2lP21WxvTgIbUov3DbZtItB3Sj1dO4xI5WH7PLjyYAyE5eYGRQwd3K0qSpaexh4cKsG8vj5pxzd8g-f6vwWjE1Co7Ax83PzP_ATmNnOWVQE-6lI287QijtH-PfdK3UEHM1d1WU67yvei0YGLTyMgC3t6F8xKwqay0B2OLEUGirDcq74xZA5qB_Ipuvys5K05nOCKbQiWujv0J_gyyaEAwszRpGc4Gy8Mrc-bhAYe7EGLh8_BoQiwJ2d4UVcBEuEmmw

Forwarding from <span class=m>0</span>.0.0.0:9090 -&gt; <span class=m>9090</span>
</code></pre></div> <p>ブラウザで <code>kubectl minio proxy</code> コマンドを実行しているサーバにアクセスするとログイン画面が表示されるので、コマンド実行時に出力された文字列を入力してログインします。</p> <p><img alt="GUI Login" src=../images/minio-operator-gui-login.png></p> <p><img alt=GUI src=../images/minio-operator-gui.png></p> <h2 id=_4>テナント作成</h2> <p>MinIO Operator を使ってテナントを作成します。</p> <div class=highlight><pre><span></span><code>$ kubectl minio tenant create minio-tenant-1 <span class=se>\</span>
    --servers <span class=m>1</span> <span class=se>\</span>
    --volumes <span class=m>4</span> <span class=se>\</span>
    --capacity 4Gi <span class=se>\</span>
    --namespace minio-tenant-1 <span class=se>\</span>
    --storage-class minio-rook-ceph-block

Tenant <span class=s1>&#39;minio-tenant-1&#39;</span> created <span class=k>in</span> <span class=s1>&#39;minio-tenant-1&#39;</span> Namespace

  Username: admin 
  Password: 4c467817-1786-418e-a346-370b3c7c50ae 
  Note: Copy the credentials to a secure location. MinIO will not display these again.

+-------------+------------------------+----------------+--------------+--------------+
<span class=p>|</span> APPLICATION <span class=p>|</span> SERVICE NAME           <span class=p>|</span> NAMESPACE      <span class=p>|</span> SERVICE TYPE <span class=p>|</span> SERVICE PORT <span class=p>|</span>
+-------------+------------------------+----------------+--------------+--------------+
<span class=p>|</span> MinIO       <span class=p>|</span> minio                  <span class=p>|</span> minio-tenant-1 <span class=p>|</span> ClusterIP    <span class=p>|</span> <span class=m>443</span>          <span class=p>|</span>
<span class=p>|</span> Console     <span class=p>|</span> minio-tenant-1-console <span class=p>|</span> minio-tenant-1 <span class=p>|</span> ClusterIP    <span class=p>|</span> <span class=m>9443</span>         <span class=p>|</span>
+-------------+------------------------+----------------+--------------+--------------+
</code></pre></div> <p><code>--volumes</code> が 4 未満だった場合、エラーとなります。</p> <div class=highlight><pre><span></span><code>$ kubectl minio tenant create minio-tenant-1 <span class=se>\</span>
    --servers <span class=m>1</span> <span class=se>\</span>
    --volumes <span class=m>3</span> <span class=se>\</span>
    --capacity 3Gi <span class=se>\</span>
    --namespace minio-tenant-1 <span class=se>\</span>
    --storage-class minio-rook-ceph-block
Error: pool <span class=c1>#0 setup must have a minimum of 4 volumes per server</span>
</code></pre></div> <h3 id=_5>トラブル</h3> <p>テナント作成コマンド実行後、MinIO Operator によって Pod が作成されますが、<code>minio-tenant-1-tls</code> Secret をマウントできずに Pod が起動してきませんでした。</p> <div class=highlight><pre><span></span><code>$ kubectl describe pods minio-tenant-1-ss-0-0 -n minio-tenant-1
<span class=o>(</span>snip<span class=o>)</span>
Events:
  Type     Reason                  Age                 From                     Message
  ----     ------                  ----                ----                     -------
  Normal   Scheduled               2m17s               default-scheduler        Successfully assigned minio-tenant-1/minio-tenant-1-ss-0-0 to kubeadm-worker3.nnstt1.work
  Normal   SuccessfulAttachVolume  2m17s               attachdetach-controller  AttachVolume.Attach succeeded <span class=k>for</span> volume <span class=s2>&quot;pvc-894acc42-ca13-4a25-87eb-d396acab50cc&quot;</span>
  Normal   SuccessfulAttachVolume  2m17s               attachdetach-controller  AttachVolume.Attach succeeded <span class=k>for</span> volume <span class=s2>&quot;pvc-1af6963b-0658-49f1-a4a0-18488ad5d6e7&quot;</span>
  Normal   SuccessfulAttachVolume  2m17s               attachdetach-controller  AttachVolume.Attach succeeded <span class=k>for</span> volume <span class=s2>&quot;pvc-6875cba8-5c7b-4bfe-95bb-ad491c2940ab&quot;</span>
  Normal   SuccessfulAttachVolume  2m17s               attachdetach-controller  AttachVolume.Attach succeeded <span class=k>for</span> volume <span class=s2>&quot;pvc-153554c7-b5e8-4e4a-95dd-28f625af163f&quot;</span>
  Warning  FailedMount             14s                 kubelet                  Unable to attach or mount volumes: unmounted <span class=nv>volumes</span><span class=o>=[</span>minio-tenant-1-tls<span class=o>]</span>, unattached <span class=nv>volumes</span><span class=o>=[</span><span class=m>3</span> minio-tenant-1-tls kube-api-access-7s52p <span class=m>0</span> <span class=m>1</span> <span class=m>2</span><span class=o>]</span>: timed out waiting <span class=k>for</span> the condition
  Warning  FailedMount             8s <span class=o>(</span>x9 over 2m16s<span class=o>)</span>  kubelet                  MountVolume.SetUp failed <span class=k>for</span> volume <span class=s2>&quot;minio-tenant-1-tls&quot;</span> : secret <span class=s2>&quot;minio-tenant-1-tls&quot;</span> not found
</code></pre></div> <h3 id=2021513>2021/5/13</h3> <p>Issue を参考にデバッグ用コンテナで証明書コピーしてみました。 https://github.com/minio/operator/issues/459#issuecomment-774319087</p> <div class=highlight><pre><span></span><code>$ kubectl run my-shell  -i --tty --image miniodev/debugger -- bash
root@my-shell:/<span class=se>\#</span> cp /var/run/secrets/kubernetes.io/serviceaccount/ca.crt /etc/ssl/certs/
root@my-shell:/<span class=se>\#</span> mc config host add myminio https://minio.minio-tenant-1.svc.cluster.local admin b4e71593-29b4-4f93-8673-cf43009f74bf
mc: &lt;ERROR&gt; Unable to initialize new <span class=nb>alias</span> from the provided credentials. Get <span class=s2>&quot;https://minio.minio-tenant-1.svc.cluster.local/probe-bucket-sign-ezqrq20bdldg/?location=&quot;</span>: dial tcp <span class=m>10</span>.97.131.201:443: connect: connection refused.
</code></pre></div> <p>パスワードがあっていなかったようなので、テナント再作成したところ、新しいテナントでは <code>minio-tenant-1-tls</code> Sercret が作成されて Pod も正常に起動しました。</p> <h3 id=2021514>2021/5/14</h3> <p>Operator を削除してからやり直したところ、<code>kubectl minio tenant create</code> を実行して 4min ほど放置したら <code>minio-tenant-1-tls</code> も作成されました。</p> <div class=highlight><pre><span></span><code>$ kubectl get secret
NAME                            TYPE                                  DATA   AGE
default-token-ntlzm             kubernetes.io/service-account-token   <span class=m>3</span>      2m24s
minio-tenant-1-console-secret   Opaque                                <span class=m>4</span>      2m22s
minio-tenant-1-console-tls      Opaque                                <span class=m>2</span>      62s
minio-tenant-1-creds-secret     Opaque                                <span class=m>2</span>      2m22s
minio-tenant-1-tls              Opaque                                <span class=m>2</span>      2m2s
operator-tls                    Opaque                                <span class=m>1</span>      2m17s
operator-webhook-secret         Opaque                                <span class=m>3</span>      2m17s

$ kubectl get pods
NAME                    READY   STATUS    RESTARTS   AGE
minio-tenant-1-console-6b7488946f-2mvkf   <span class=m>1</span>/1     Running   <span class=m>0</span>          2m43s
minio-tenant-1-console-6b7488946f-6djht   <span class=m>1</span>/1     Running   <span class=m>0</span>          2m43s
minio-tenant-1-ss-0-0                     <span class=m>1</span>/1     Running   <span class=m>0</span>          3m43s
</code></pre></div> <p>再度試したところ、今度は作られませんでした。 CSR リソースを確認したところ、前回作られたと思われるものが残っていました。</p> <div class=highlight><pre><span></span><code>$ kubectl get csr
NAME                                        AGE   SIGNERNAME                     REQUESTOR                                             CONDITION
minio-tenant-1-console-minio-tenant-1-csr   44m   kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
minio-tenant-1-minio-tenant-1-csr           45m   kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
operator-minio-operator-csr                 46m   kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
</code></pre></div> <p>CSR リソースを削除して再々度チャレンジ、<code>kubectl minio init</code> 後の CSR リソース。</p> <div class=highlight><pre><span></span><code>$ kubectl get csr
NAME                          AGE   SIGNERNAME                     REQUESTOR                                             CONDITION
operator-minio-operator-csr   96s   kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
</code></pre></div> <p><code>kubectl minio tenant create</code> 後。</p> <div class=highlight><pre><span></span><code>$ kubectl get csr
NAME                                        AGE    SIGNERNAME                     REQUESTOR                                             CONDITION
minio-tenant-1-console-minio-tenant-1-csr   17s    kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
minio-tenant-1-minio-tenant-1-csr           77s    kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
operator-minio-operator-csr                 4m5s   kubernetes.io/legacy-unknown   system:serviceaccount:minio-operator:minio-operator   Approved,Issued
</code></pre></div> <p>新しく CSR リソースが作られ、<code>minio-tenant-1-tls</code> も作成されました。</p> <h2 id=_6>外部公開用サービス</h2> <p>Kubernetes クラスタ外のアプリケーションから MinIO テナントに接続するためには Ingress や Load Balancer が必要です。</p> <p>今回は MinIO 用の Load Balancer を作成します。</p> <h3 id=minio>MinIO</h3> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-loadbalancer</span><span class=w></span>
<span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1</span><span class=w></span>
<span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>external-dns.alpha.kubernetes.io/hostname</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1.nnstt1.work.</span><span class=w>    </span><span class=c1># ExternalDNS 用アノテーション</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span><span class=w></span>
<span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9000</span><span class=w></span>
<span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9000</span><span class=w></span>
<span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class=w></span>
<span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>v1.min.io/tenant</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1</span><span class=w></span>
</code></pre></div> <h3 id=console>Console</h3> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Service</span><span class=w></span>
<span class=nt>metadata</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">console-loadbalancer</span><span class=w></span>
<span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>external-dns.alpha.kubernetes.io/hostname</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-console.nnstt1.work.</span><span class=w>    </span><span class=c1># ExternalDNS 用アノテーション</span><span class=w></span>
<span class=nt>spec</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span><span class=w></span>
<span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https-console</span><span class=w></span>
<span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9443</span><span class=w></span>
<span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span><span class=w></span>
<span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">9443</span><span class=w></span>
<span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>v1.min.io/console</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">minio-tenant-1-console</span><span class=w></span>
</code></pre></div> <h2 id=_7>アンインストール</h2> <h3 id=_8>テナント削除</h3> <p>MinIO Operator で作成したテナントを削除する方法です。</p> <p>tenant リソースは namespace 毎に作成されるため、<code>-n</code> オプションで対象の namespace を指定してください。</p> <div class=highlight><pre><span></span><code><span class=c1># テナント削除</span>
$ kubectl minio tenant delete minio-tenant-1 -n minio-tenant-1

This will delete the Tenant minio-tenant-1 and ALL its data. Do you want to proceed?: y
Deleting MinIO Tenant minio-tenant-1
Deleting MinIO Tenant Credentials Secret minio-tenant-1-creds-secret
Deleting MinIO Tenant Console Secret minio-tenant-1-console-secret

<span class=c1># namespace 確認</span>
$ kubectl get pods -n minio-tenant-1
No resources found <span class=k>in</span> minio-tenant-1 namespace.
$ kubectl get secret -n minio-tenant-1
NAME                  TYPE                                  DATA   AGE
default-token-swx2m   kubernetes.io/service-account-token   <span class=m>3</span>      2d
</code></pre></div> <h3 id=operator>Operator 削除</h3> <p>Kubernetes クラスタから MinIO Operator を削除する方法です。</p> <div class=highlight><pre><span></span><code>$ kubectl minio delete

Are you sure you want to delete ALL the MinIO Tenants and MinIO Operator?: y
namespace <span class=s2>&quot;minio-operator&quot;</span> deleted
serviceaccount <span class=s2>&quot;minio-operator&quot;</span> deleted
clusterrole.rbac.authorization.k8s.io <span class=s2>&quot;minio-operator-role&quot;</span> deleted
clusterrolebinding.rbac.authorization.k8s.io <span class=s2>&quot;minio-operator-binding&quot;</span> deleted
customresourcedefinition.apiextensions.k8s.io <span class=s2>&quot;tenants.minio.min.io&quot;</span> deleted
service <span class=s2>&quot;operator&quot;</span> deleted
deployment.apps <span class=s2>&quot;minio-operator&quot;</span> deleted
serviceaccount <span class=s2>&quot;console-sa&quot;</span> deleted
clusterrole.rbac.authorization.k8s.io <span class=s2>&quot;console-sa-role&quot;</span> deleted
clusterrolebinding.rbac.authorization.k8s.io <span class=s2>&quot;console-sa-binding&quot;</span> deleted
configmap <span class=s2>&quot;console-env&quot;</span> deleted
service <span class=s2>&quot;console&quot;</span> deleted
deployment.apps <span class=s2>&quot;console&quot;</span> deleted
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=フッター> <a href=../zalando-postgres-operator/ class="md-footer__link md-footer__link--prev" aria-label="前: Zalando Postgres Operator" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 前 </span> Zalando Postgres Operator </div> </div> </a> <a href=../../prometheus/prometheus/ class="md-footer__link md-footer__link--next" aria-label="次: Prometheus" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 次 </span> Prometheus </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs"], "translations": {"clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\u3000\u3001\u3002\uff0c\uff0e]+", "search.placeholder": "\u691c\u7d22", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script> <script src=../../assets/javascripts/bundle.960e086b.min.js></script> </body> </html>