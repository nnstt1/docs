# Zalando Postgres Operator

Zalando 社が開発している Postgres Operator をデプロイする手順です。

## Operator デプロイ

[公式ドキュメント :fa-external-link:](https://github.com/zalando/postgres-operator/blob/v1.6.0/docs/quickstart.md#deployment-options){target=_blank}

3種類のデプロイ方法があります。

- マニュアル
- Kustomize
- Helm chart

### マニュアル

```sh
git clone https://github.com/zalando/postgres-operator.git
cd postgres-operator/

kubectl create namespace zalando-postgres
config set-context $(kubectl config current-context) --namespace=zalando-postgres

kubectl apply -f manifests/configmap.yaml
kubectl apply -f manifests/operator-service-account-rbac.yaml  # namespace: defualt のものがあるので注意
kubectl apply -f manifests/postgres-operator.yaml
kubectl apply -f manifests/api-service.yaml
```

## Web UI デプロイ

Web UI から PostgreSQL クラスタを作成・管理できます。
### マニュアル

Web UI 用のマニフェストを使ってデプロイします。

```sh
kubectl apply -f ui/manifests/
```

Web UI は任意の namespace を管理対象とします。
deployment.yaml の `TARGET_NAMESPACE` に **"*"** を指定することで、全 namespace を対象とすることができます。

```yaml
# deployment.yaml
env:
  - name: "TARGET_NAMESPACE"
    value: "default"    # "*" に変更
```


!!! attention
    kustomize のマニフェストで以下のエラーが出てデプロイできてません。

    ```sh    
    error: unable to recognize "manifests/kustomization.yaml": no matches for kind "Kustomization" in version "kustomize.config.k8s.io/v1beta1"
    ```

!!! note
    自宅ラボでは Ingress ではなく type: Loadbalancer を使っています。

## PostgreSQL デプロイ

Postgres Operator を使って PostgreSQL をデプロイする方法は2種類あります。

- マニフェスト
- Web UI

### マニフェスト

公式リポジトリにサンプルマニフェストがあるので、参照しながら Postgres マニフェストを用意してデプロイします。

```yaml
# example
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: acid-example
  namespace: default
  labels:
    team: acid
spec:
  teamId: acid
  postgresql:
    version: "13"    # note: String
  numberOfInstances: 1
  volume:
    size: 1Gi
    storageClass: rook-ceph-block
  users:
    example: []
  databases:
    example: example
  allowedSourceRanges:
  resources:
    requests:
      cpu: 100m
      memory: 100Mi
    limits:
      cpu: 500m
      memory: 500Mi
```

### Web UI

デプロイした Service または Ingress にアクセスします。
クラスタ作成画面が表示されるので、項目入力して Create cluster。

![zalando-postgres-operator-webui-create](../images/zalando-postgres-operator-webui-create.png)

!!! attention
    Web UI 経由でデプロイする場合に volume.storageClass を指定できません。
    Kubernetes クラスタにデフォルト StorageClass を設定していないと PVC が Pending のままでエラーとなります。

    [Change the default StorageClass](https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/) を参照してデフォルト StorageClass を設定します。

## 確認

作成した Postgresql クラスタに接続できるか確認します。

### ユーザパスワード

ユーザパスワードは Operator により自動的に作成され、`{username}.{team}-{clustername}.credentials.postgresql.acid.zalan.do` という Secret に格納されます。

```sh
# namespace: default
export PGMASTER=$(kubectl get pods -o jsonpath={.items..metadata.name} -l application=spilo)
kubectl port-forward $PGMASTER 6432:5432

kubectl get secret postgres.acid-example.credentials -o 'jsonpath={.data.password}' | base64 -d
export PGSSLMODE=require
psql -U postgres -h localhost -p 6432
```

## CentOS 7 への psql インストール

```sh
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo yum install -y postgresql13
```

## 証明書

[Custom TLS certificates :fa-external-link:](https://postgres-operator.readthedocs.io/en/latest/user/#custom-tls-certificates){target=_blank}

デフォルトではクラスタ作成時に TLS 証明書が自動的に作成されるので、以下の手順でカスタム証明書を設定します。

```sh
# Secret
kubectl create secret tls pg-tls \
  --key pg-tls.key \  # 秘密鍵
  --cert pg-tls.crt   # 証明書
```

```yaml
# kind: postgresql
spec:
  tls:
    secretName: pg-tls
```

## pg_hba.conf

マニフェストで指定することで pg_hba.conf の設定を上書きすることができます。

```yaml
spec:
  patroni:
    pg_hba:
      - local   all all           trust
      - hostssl all all 0.0.0.0/0 trust
      - host    all all 0.0.0.0/0 trust
```

マニフェストで指定しない場合のデフォルトは以下のようになっています。

```sh
root@acid-awx-0:/home/postgres/pgdata/pgroot/data# cat pg_hba.conf
# Do not edit this file manually!
# It will be overwritten by Patroni!
local   all             all                                   trust
hostssl all             +zalandos    127.0.0.1/32       pam
host    all             all                127.0.0.1/32       md5
hostssl all             +zalandos    ::1/128            pam
host    all             all                ::1/128            md5
hostssl replication     standby all                md5
hostnossl all           all                all                reject
hostssl all             +zalandos    all                pam
hostssl all             all                all                md5
```